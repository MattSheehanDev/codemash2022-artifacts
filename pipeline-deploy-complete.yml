trigger:
  branches:
    include:
      - master
  paths:
   include:
     - pipeline-deploy-complete.yml

resources:
  repositories:
    - repository: dotnet-core-api   # Name used during the checkout step
      type: Github
      endpoint: MattSheehanDev      # Service Connection name
      name: Azure-Samples/dotnet-core-api

pool:
  vmImage: windows-latest

stages:
  - stage: PublishApp
    displayName: Publish App
    jobs:
      - job: Publish
        steps:
          - checkout: dotnet-core-api
          - task: DotNetCoreCLI@2
            displayName: Build dotnet-core-api
            inputs:
              command: 'publish'
              projects: 'TodoApi.csproj'
              arguments: '-o $(Build.ArtifactStagingDirectory)'
          - publish: '$(Build.ArtifactStagingDirectory)'
            artifact: api

  - stage: DeployAppServiceOne
    displayName: Deploy App
    dependsOn: PublishApp
    jobs:
        # deployment jobs are a special kind of job that can
        # record deployment history and deployment strategy.
      - deployment: DeployApi
        displayName: Deploy dotnet-core-api
        environment: env-one
        strategy:
          runOnce:
            deploy:
              steps:
              - task: DownloadPipelineArtifact@2
                inputs:
                  buildType: current
                  artifact: api
              - task: AzureRmWebAppDeployment@4
                inputs:
                  ConnectionType: 'AzureRM'
                  WebAppKind: 'webApp'
                  WebAppName: 'api-app-east'
                  ResourceGroupName: 'artifacts-rg'
                  Package: '$(Agent.BuildDirectory)/**/*.zip'
                  ConnectedServiceName: CodeMash2022-sp

  - stage: DeployAppServiceTwo
    displayName: Deploy App
    dependsOn: PublishApp
    jobs:
      - deployment: DeployApi
        displayName: Deploy dotnet-core-api
        environment: env-two
        strategy:
          runOnce:
            deploy:
              steps:
                # The download keywork is a shortcut for
                # the task DownloadPipelineArtifact above.
              - download: current
                artifact: api
              - task: AzureRmWebAppDeployment@4
                inputs:
                  ConnectionType: 'AzureRM'
                  WebAppKind: 'webApp'
                  WebAppName: 'api-app-east2'
                  ResourceGroupName: 'artifacts-rg'
                  Package: '$(Agent.BuildDirectory)/**/*.zip'
                  ConnectedServiceName: CodeMash2022-sp

